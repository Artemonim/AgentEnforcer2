# Концепция `AGENTS.md`: операционный контракт для работы с AI-агентом

Этот документ объясняет, *зачем* и *как* использовать `AGENTS.md` в репозитории проекта, чтобы AI‑агент работал предсказуемо: быстро находил нужные знания, не ломал запрещённые зоны, соблюдал ключевые инженерные ограничения и **всегда** выполнял локальную CI перед финальным отчётом.

> Важно: это не попытка "стандартизировать prompting" или заменить [AgentCompass](https://github.com/Artemonim/AgentCompass). Это практическая модель: `AGENTS.md` как **контракт исполнения** (operational contract).

## `AGENTS.md` и `README.md`: разделение ролей

- `README.md` — витрина проекта, стартовый How To для человека.
- `AGENTS.md` — производственный контракт исполнения. Он автоматически подхватывается в контекст всеми актуальными агентами.

Важно:
- не стоит перегружать `README.md` производственными деталями, которые важны прежде всего агенту;
- не стоит превращать `AGENTS.md` в "README для людей/неспециалистов": люди могут читать его при желании, но его главная задача — сделать работу агента воспроизводимой и проверяемой.

## Проектно-независимые правила поведения агента (Agent Policy)

Во многих проектах существует набор универсальных правил для агента (в духе [AgentCompass/COMPASS.md](https://github.com/Artemonim/AgentCompass/blob/master/COMPASS.md)): безопасность, формат отчёта, требования и т.п.

Рекомендация:
- Держите такие правила в настройках среды, где запускается агент (например, Cursor User Rules или аналогичные "User Rules / System Prompt" в вашей агентной системе);
- Если вашей IDE/агентной системе нельзя указать отдельные проектно‑независимые правила поведения (как в Codex или [начальной реализации Cursor Subagents](https://forum.cursor.com/t/subagents-do-not-receive-user-rules/148987)), вынесите их в отдельный файл репозитория (например, `.cursor\rules\CodexRules.md`, `AGENT_RULES.md`, `AGENT_POLICY.md`, etc) и ссылайтесь на него в начале каждого промпта или из `AGENTS.md`.

```md
Ты субагент.

Важно: В самом начале работы обязательно полностью прочти ".cursor\rules\CodexRules.md" и следуй им как своим основным правилам.
```

> `AGENTS.md` должен давать справку о конкретном текущем проекте.

---

## Структура AGENTS.md

### Доктрина (первое, что должен увидеть агент)

Доктрина — это 1–3 коротких декларативных правила, которые агент обязан учитывать **до** написания кода. Это не советы, а ограничения на дизайн решений, принятых в конкретном проекте. Допустимо несколько неконфликтующих непересекающихся доктрин одновременно.

Пример доктрины "performance-first":

- Любой компонент, который может стать тяжёлым (CPU/GPU/IO) или влияет на responsiveness, проектируется как job/async‑система: snapshot → parallel work → apply, с отменой/суперседингом, backpressure и наблюдаемостью.
- Последовательная реализация допустима только если она стабильно укладывается в целевые бюджеты (latency/frame time/IO) и не является бутылочным горлышком; выбор подтверждается метриками и/или профайлингом.

Зачем это в `AGENTS.md`:
- агент не имеет права "сначала сделать просто, потом оптимизировать", если доктрина требует другой архитектуры;
- доктрина снижает риск "правильного, но неприемлемого" решения.

### Карта документации (куда смотреть)

`AGENTS.md` должен давать агенту быстрые ссылки на "источник истины":
- что читать для верхнеуровневого ознакомления с проектом;
- где лежат главные документы и что они дают;
- где искать решения и термины.

#### Ссылки на большие документы и точечные разделы

Если документ большой, полезно добавлять указатели на **конкретные диапазоны строк** или секции, чтобы агент не перечитывал всё целиком. Формат может быть таким же, как в [LivingLayers](https://livinglayers.ru/?utm_source=github&utm_medium=organic&utm_campaign=agentenforcer2&utm_content=agents.md):

```md
- `doc\decision_log.md` содержит перечень важных принятых решений по дизайну проекта с их обоснованием.
- - Pre-Alpha Decisions | lines 78-334
- - - ADR-001: Hybrid Physics Architecture | 80-130
- - - ADR-002: Alpha Progression as Go/No-Go Gates | 134-162
- - - ADR-003: Material System Extensibility | 166-205
```

Рекомендация:
- держать эти ссылки на уровне "маяков", не пытаясь покрыть всё;
- обновлять line ranges, когда документ существенно редактируется.

### Code Map (куда смотреть в коде)

Code Map нужен, чтобы агент не занимался "разведкой репозитория" и не тратил итерации на неправильные папки.

#### Принцип стабильности

В Code Map стоит выносить **только верхнеуровневые пути**, которые редко меняются:
- `src/` — основной код приложения
- `backend/` — серверная часть
- `tools/` — утилиты и скрипты проекта

Почему только верхнеуровневые:
- нижние директории чаще переезжают и быстро устаревают;
- агенту важнее "куда смотреть в целом", чем "в какой конкретно подпапке лежит один файл".

#### Дополнение: ссылки на документацию рядом с путями

Если полезно, можно рядом с путями оставлять ссылки на конкретные разделы документации в том же формате, что и выше (например, с line ranges). Это ускоряет переход "код ↔ объяснение".

### Read-only зоны (если применимо)

Если в проекте есть субмодули, vendor, автогенерация или "не трогать руками", это нужно объявить явно.

Пример:
- Не изменяй файлы внутри `doc/Unity` и `doc/pytorch`: это субмодули, treat as read-only.

Зачем это в `AGENTS.md`:
- агентам свойственно "чинить всё подряд"; явный запрет предотвращает дорогие ошибки.

### Команда финальной верификации (обязательный ритуал)

`AGENTS.md` должен содержать явную команду, которую агент обязан выполнить перед тем как сказать "готово".

Пример:

```md
### Контроль качества

- Ты должен использовать раннер `run.ps1` для проверки качества кода. Всегда используй таймаут терминала не менее 25 минут.
- По умолчанию запускай `./run.ps1 -Fast -SkipLaunch`.
- В большинстве случаев тебе достаточно отправить `./run.ps1 -Fast -SkipLaunch` в свой терминал - это локальный CI который выполнит все проверки и предоставит тебе удобный ответ.
```

Почему это критично:
- без этой строки агент легко заканчивает работу по принципу "выглядит правильно" без запуска CI;
- локальная CI — это "двигатель правок": *написал → прогнал → исправил → повторил*.

#### Таймаут локальной CI: практическая необходимость для Cursor v2.4.21

В Cursor v2.4.21 (как и в OpenAI Codex) невозможно запустить терминал без таймаута. Если команда не успевает завершиться в отведённое время, терминал может быть уведён в background, и агент теряет доступ к выводу/процессу — это ломает агентный цикл "запусти CI → прочитай вывод → исправь".

Рекомендация:
- Указывайте таймаут для запуска локальной CI с запасом +10% от ожидаемого времени полного прогона вашего проекта;
- Обновляйте таймаут по мере роста проекта.

### Глоссарий: "выжимка" часто используемых терминов

В больших проектах глоссарий часто живёт в отдельном документе (например, `doc/glossary.md`). Но в `AGENTS.md` имеет смысл продублировать **самые частые** термины, которые постоянно встречаются в общении с агентом.

Как это делать:
- оставлять **максимально краткое** описание (1 строка);
- не пытаться перенести весь словарь: цель — снизить число уточняющих вопросов и интерпретационных ошибок.

Пример:
```md
- раннер — `run.ps1`
- сборщик — `build.ps1`
- обломок — кусок структуры, получившийся после разрушения
- осколок — одновоксельная частица (dust), получившаяся после разрушения
```

---

## Анти-паттерны `AGENTS.md`

- Делать `AGENTS.md` "учебником по языку/стилю": для этого существуют User Rules, линтеры, форматтеры, конфиги, CONTRIBUTION.md и прочие проектные стайлгайды.
- Дублировать флаги и help локальной CI: источник истины должен быть в `run.ps1 --help`.
- Писать слишком детализированный глоссарий или карту подпапок: она займёт слишком много токенов, быстро устареет и введёт агента в заблуждение.
